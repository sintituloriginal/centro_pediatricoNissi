<!-- Bot limitado por opciones (sin IA) -->
<button id="bot-toggle" aria-controls="bot-panel" aria-expanded="false" aria-label="Abrir chat">💬</button>

<div id="bot-panel" hidden aria-hidden="true" role="dialog" aria-label="Asistente Virtual">
  <div class="bot-header">
    <strong>Asistente</strong>
    <button id="bot-close" aria-label="Cerrar" type="button">✕</button>
  </div>

  <div id="bot-messages" class="bot-messages" aria-live="polite"></div>
  <div id="bot-quick" class="bot-quick"></div>

  <div class="bot-footer">
    <!-- entrada libre desactivada; quita hidden si la quieres -->
    <form id="bot-form" hidden>
      <input id="bot-input" type="text" placeholder="Escribe tu duda…" />
      <button type="submit">Enviar</button>
    </form>
  </div>
</div>

<style>
  /* ==== base / posiciones ==== */
  #bot-panel[hidden]{ display:none !important; }

  #bot-toggle{
    position:fixed; right:18px; bottom:18px; z-index:2147483647;
    width:56px; height:56px; border-radius:50%; border:0; cursor:pointer;
    box-shadow:0 8px 24px rgba(0,0,0,.18); background:#0fb6a6; color:#fff; font-size:24px;
  }

  #bot-panel{
    position:fixed; right:18px; bottom:86px; z-index:2147483646;
    width:360px; max-width:92vw; max-height:min(70vh,560px);
    background:#fff; border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.22);
    display:flex; flex-direction:column; overflow:hidden;
    font-family: inherit;
  }

  /* ==== header siempre arriba ==== */
  #bot-panel .bot-header{
    position:sticky; top:0; z-index:1;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; background:#0fb6a6;
  }
  #bot-panel .bot-header, 
  #bot-panel .bot-header *, 
  #bot-panel .bot-header strong{
    color:#fff !important; text-decoration:none !important;
  }
  #bot-close{
    border:none; background:transparent; font-size:18px; cursor:pointer;
  }

  /* ==== área mensajes / botones ==== */
  #bot-panel .bot-messages{
    padding:12px; gap:10px; overflow:auto; display:flex; flex-direction:column; flex:1;
    background:#fafaf6;
  }
  #bot-panel .bubble{ padding:10px 12px; border-radius:12px; max-width:85%; line-height:1.35; }
  #bot-panel .bot{  align-self:flex-start; background:#f2f3f7; }
  #bot-panel .user{ align-self:flex-end;   background:#e8f7f5;  }

  #bot-panel .bot-quick{
    display:flex; flex-wrap:wrap; gap:10px; padding:12px; border-top:1px solid #eceff3; background:#fff;
  }

  /* ==== botones rápidos / normalización ==== */
  #bot-panel button{ font: inherit; }
  #bot-panel .qbtn{
    border:1px solid #e11d48; color:#e11d48; background:#fff; border-radius:16px;
    padding:6px 10px; cursor:pointer; font-size:14px;
  }
  #bot-panel .qbtn.primary{ background:#0fb6a6; color:#fff; border-color:#0fb6a6; }

  #bot-panel .bot-footer{ padding:10px; border-top:1px solid #eceff3; background:#fff; }
  #bot-form{ display:flex; gap:8px; }
  #bot-input{ flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; }
</style>

<script>
(function(){
  /* 🔧 Personaliza estos datos */
  const PHONE = "+56 9 8194 4030";
  const WA    = "https://wa.me/56981944030";
  const MAPS  = "https://maps.google.com/?q=Centro+Pediatrico+Nissi";
  const EXAMENES_ANCHOR = "#examenes"; // cambia por tu id real

  /* 🌳 Flujo sin IA */
  const FLOW = {
    root: {
      msg: "¡Hola! Soy el asistente del Centro Pediátrico Nissi. ¿Sobre qué deseas consultar?",
      options: [
        {label:"Información General", next:"info"},
        {label:"Nuestros Servicios",  next:"servicios"},
        {label:"Exámenes",            next:"examenes"},
        {label:"Contactarnos",        next:"contacto"},
      ]
    },
    info: {
      msg: "Atendemos de lunes a viernes 9:00–18:00. Estamos en Av. … (reemplaza por tu dirección). Para agendar exámenes necesitas una orden médica.",
      options: [
        {label:"Horarios",      next:"horarios"},
        {label:"¿Cómo llegar?", action:()=>window.open(MAPS,'_blank','noopener')},
        {label:"Formas de pago",next:"pago"},
        {label:"Volver",        next:"root"},
      ]
    },
    horarios: {
      msg: "Lunes a Viernes 9:00–18:00. Sábados según disponibilidad.",
      options: [
        {label:"¿Cómo llegar?", action:()=>window.open(MAPS,'_blank','noopener')},
        {label:"Volver",        next:"info"},
      ]
    },
    pago: {
      msg: "Aceptamos efectivo, débito y transferencia. (Ajusta según tu realidad.)",
      options: [{label:"Volver", next:"info"}]
    },
    servicios: {
      msg: "Ofrecemos consulta pediátrica, matrona y toma de exámenes. ¿Cómo te ayudamos?",
      options: [
        {label:"Agendar por WhatsApp", action:()=>window.open(WA,'_blank','noopener'), klass:"primary"},
        {label:"Llamar",               action:()=>location.href=`tel:${PHONE.replace(/\s+/g,'')}`},
        {label:"Ver exámenes",         action:()=>location.hash=EXAMENES_ANCHOR},
        {label:"Volver",               next:"root"},
      ]
    },
    examenes: {
      msg: "Realizamos, entre otros: OCT mácula, Retinografía, Test de Schirmer, Topografía, Pupilometría. Abre la sección para ver detalle.",
      options: [
        {label:"Abrir exámenes", action:()=>location.hash=EXAMENES_ANCHOR, klass:"primary"},
        {label:"Requisitos",     next:"requisitos"},
        {label:"Volver",         next:"root"},
      ]
    },
    requisitos: {
      msg: "Para agendar exámenes es necesaria una orden médica.",
      options: [
        {label:"Agendar por WhatsApp", action:()=>window.open(WA,'_blank','noopener'), klass:"primary"},
        {label:"Volver",               next:"examenes"},
      ]
    },
    contacto: {
      msg: "Elige cómo prefieres contactarnos:",
      options: [
        {label:"Llamar",   action:()=>location.href=`tel:${PHONE.replace(/\s+/g,'')}`, klass:"primary"},
        {label:"WhatsApp", action:()=>window.open(WA,'_blank','noopener')},
        {label:"Correo",   action:()=>location.href="mailto:contacto@tudominio.cl"},
        {label:"Volver",   next:"root"},
      ]
    }
  };

  /* 📦 DOM */
  const toggle = document.getElementById('bot-toggle');
  const panel  = document.getElementById('bot-panel');
  const closeB = document.getElementById('bot-close');
  const msgsEl = document.getElementById('bot-messages');
  const quick  = document.getElementById('bot-quick');

  /* 🧩 helpers */
  function openPanel(){
    panel.removeAttribute('hidden');
    panel.setAttribute('aria-hidden','false');
    toggle.setAttribute('aria-expanded','true');
  }
  function closePanel(){
    panel.setAttribute('hidden','');
    panel.setAttribute('aria-hidden','true');
    toggle.setAttribute('aria-expanded','false');
  }
  function bubble(text, who='bot'){
    const b = document.createElement('div');
    b.className = 'bubble ' + who;
    b.textContent = text;
    msgsEl.appendChild(b);
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }
  function renderOptions(opts){
    quick.innerHTML = '';
    (opts || []).forEach(o=>{
      const btn = document.createElement('button');
      btn.className = 'qbtn' + (o.klass ? ' ' + o.klass : '');
      btn.type = 'button';
      btn.textContent = o.label;
      btn.addEventListener('click', ()=>{
        bubble(o.label,'user');
        if (o.next){ state = o.next; step(); }
        else if (typeof o.action === 'function'){ o.action(); }
      });
      quick.appendChild(btn);
    });
  }

  /* ▶️ motor */
  let state = 'root';
  function step(){
    try{
      const node = FLOW[state] || FLOW.root;
      bubble(node.msg, 'bot');
      renderOptions(node.options);
    }catch(e){
      console.error('Bot error:', e);
      bubble('Lo siento, hubo un problema. Intenta nuevamente.', 'bot');
      renderOptions([{label:'Volver al inicio', next:'root', klass:'primary'}]);
    }
  }

  /* 🎛️ eventos: abre SIEMPRE con saludo */
  toggle.addEventListener('click', ()=>{
    const isHidden = panel.hasAttribute('hidden');
    if (isHidden){
      openPanel();
      msgsEl.innerHTML = '';
      quick.innerHTML = '';
      state = 'root';
      step();
    } else {
      closePanel();
    }
  });
  closeB.addEventListener('click', closePanel);

  /* arranca cerrado */
  closePanel();
})();
</script>
